# nzrmohammad/vpanel-manager/VPanel-Manager-063e72609384d4f0fb543665c1d1c7f6335ca45d/bot/user_handlers/wallet.py
import logging
from telebot import types
from ..database import db
from ..menu import menu
from ..utils import escape_markdown, _safe_edit, load_service_plans, to_shamsi, parse_volume_string
from ..language import get_string
from ..config import ADMIN_IDS, CARD_PAYMENT_INFO
from .. import combined_handler
from telebot.apihelper import ApiTelegramException


logger = logging.getLogger(__name__)
bot, admin_conversations = None, None

def initialize_handlers(b, conv_dict):
    """Ù…Ù‚Ø§Ø¯ÛŒØ± bot Ùˆ admin_conversations Ø±Ø§ Ø§Ø² ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    global bot, admin_conversations
    bot = b
    admin_conversations = conv_dict

def handle_wallet_callbacks(call: types.CallbackQuery):
    """Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… callback Ù‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„."""
    try:
        action_parts = call.data.split(':')
        action = action_parts[1]
        
        if action == 'main':
            show_wallet_main(call)
        elif action == 'charge':
            start_charge_flow(call)
        elif action == 'history':
            show_wallet_history(call)
        elif action == 'buy_confirm':
            plan_name = action_parts[2]
            confirm_purchase(call, plan_name)
        elif action == 'buy_execute':
            plan_name = action_parts[2]
            execute_purchase(call, plan_name)
        elif action == 'insufficient':
            bot.answer_callback_query(call.id, "Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø±Ø§ Ø´Ø§Ø±Ú˜ Ú©Ù†ÛŒØ¯.", show_alert=True)
    except IndexError:
        logger.warning(f"Invalid wallet callback received: {call.data}")
        bot.answer_callback_query(call.id, "Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.", show_alert=True)

def show_wallet_main(call: types.CallbackQuery):
    """Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."""
    uid = call.from_user.id
    user_data = db.user(uid)
    balance = user_data.get('wallet_balance', 0.0) if user_data else 0.0
    lang_code = db.get_user_language(uid)
    
    _safe_edit(uid, call.message.message_id, f"*{escape_markdown(get_string('wallet', lang_code))}*",
               reply_markup=menu.wallet_main_menu(balance, lang_code))

def start_charge_flow(call: types.CallbackQuery):
    """Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ù…Ø¨Ù„Øº Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø±Ú˜ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†Ø¯."""
    uid = call.from_user.id
    lang_code = db.get_user_language(uid)
    prompt = "Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„ØºÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø´Ø§Ø±Ú˜ Ú©Ù†ÛŒØ¯ \\(Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†\\) ÙˆØ§Ø±Ø¯ Ù†Ù…Ø§ÛŒÛŒØ¯:\n\n*Ù…Ø«Ø§Ù„: 50000*"
    _safe_edit(uid, call.message.message_id, prompt,
               reply_markup=menu.user_cancel_action("wallet:main", lang_code=lang_code))
    bot.register_next_step_handler(call.message, get_charge_amount, original_msg_id=call.message.message_id)

def get_charge_amount(message: types.Message, original_msg_id: int):
    """Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù‡ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Øª Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    uid = message.from_user.id
    lang_code = db.get_user_language(uid)
    try:
        bot.delete_message(uid, message.message_id)
    except Exception:
        pass

    try:
        amount = int(message.text.strip())
        if amount < 1000: 
            raise ValueError("Ù…Ø¨Ù„Øº Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª")
        
        db.create_charge_request(uid, amount, original_msg_id)
        
        card_info = (
            f"*{escape_markdown('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª')}*\n\n"
            f"Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº `{amount:,.0f}` ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ø±Ø¯Ù‡ Ùˆ Ø³Ù¾Ø³ Ø§Ø² Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ú¯Ø±ÙØªÙ‡ Ùˆ Ø¢Ù† Ø±Ø§ Ø¯Ø± Ù‡Ù…ÛŒÙ† ØµÙØ­Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\\.\n\n"
            f"*{escape_markdown(CARD_PAYMENT_INFO.get('card_holder', ''))}*\n"
            f"`{escape_markdown(CARD_PAYMENT_INFO.get('card_number', ''))}`\n\n"
            f"âš ï¸ {escape_markdown('ØªÙˆØ¬Ù‡: Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯ØŒ Ø¨Ø§ÛŒØ¯ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ù…Ø§Ù†ÛŒØ¯.')}"
        )
        _safe_edit(uid, original_msg_id, card_info,
                         reply_markup=menu.user_cancel_action("wallet:main", lang_code))
        bot.register_next_step_handler(message, get_receipt, original_msg_id=original_msg_id)

    except (ValueError, TypeError):
        error_prompt = escape_markdown("âŒ Ù…Ø¨Ù„Øº ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ùˆ Ø­Ø¯Ø§Ù‚Ù„ Û±,Û°Û°Û° ØªÙˆÙ…Ø§Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\n\n*Ù…Ø«Ø§Ù„ ØµØ­ÛŒØ­: 50000*")
        # âœ… Ø§ØµÙ„Ø§Ø­ Ø§ØµÙ„ÛŒ: parse_mode="MarkdownV2" Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ ØªØ§ Ø§Ø³ØªØ§ÛŒÙ„ ØµØ­ÛŒØ­ Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯
        _safe_edit(uid, original_msg_id, error_prompt, 
                   reply_markup=menu.user_cancel_action("wallet:main", lang_code), parse_mode="MarkdownV2")
        bot.register_next_step_handler(message, get_charge_amount, original_msg_id=original_msg_id)

def get_receipt(message: types.Message, original_msg_id: int):
    """Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    uid = message.from_user.id
    lang_code = db.get_user_language(uid)
    try:
        bot.delete_message(uid, message.message_id)
    except Exception:
        pass

    charge_request = db.get_pending_charge_request(uid, original_msg_id)
    if not charge_request or not message.photo:
        bot.clear_step_handler_by_chat_id(uid)
        return

    amount = charge_request['amount']
    
    wait_message = escape_markdown("âœ… Ø±Ø³ÛŒØ¯ Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ù¾Ø³ Ø§Ø² ØªØ§ÛŒÛŒØ¯ ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†ØŒ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø´Ø§Ø±Ú˜ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.")
    _safe_edit(uid, original_msg_id, wait_message, 
               reply_markup=menu.user_cancel_action("wallet:main", lang_code))
    
    user_info = message.from_user
    user_db_data = db.user(uid)
    current_balance = user_db_data.get('wallet_balance', 0.0) if user_db_data else 0.0

    caption_lines = [
        "ğŸ’¸ *Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¬Ø¯ÛŒØ¯*",
        f"ğŸ†” *Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:* `{charge_request['id']}`",
        "",
        f"ğŸ‘¤ *Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±:* {escape_markdown(user_info.first_name)}",
        f"ğŸ†” *Ø§ÛŒØ¯ÛŒ:* `{user_info.id}`"
    ]
    if user_info.username:
        caption_lines.append(f"ğŸ”— *ÛŒÙˆØ²Ø±Ù†ÛŒÙ…:* @{escape_markdown(user_info.username)}")
    
    caption_lines.extend([
        f"ğŸ’° *Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ:* `{current_balance:,.0f}` ØªÙˆÙ…Ø§Ù†",
        "",
        f"ğŸ’³ *Ù…Ø¨Ù„Øº Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ:* `{amount:,.0f}` ØªÙˆÙ…Ø§Ù†"
    ])
    
    caption = "\n".join(caption_lines)
    
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(
        types.InlineKeyboardButton("âœ… ØªØ§ÛŒÛŒØ¯", callback_data=f"admin:charge_confirm:{charge_request['id']}"),
        types.InlineKeyboardButton("âŒ Ø±Ø¯", callback_data=f"admin:charge_reject:{charge_request['id']}")
    )
    
    for admin_id in ADMIN_IDS:
        try:
            bot.send_photo(admin_id, message.photo[-1].file_id, caption=caption, reply_markup=kb, parse_mode="MarkdownV2")
        except Exception as e:
            logger.error(f"Failed to forward receipt to admin {admin_id}: {e}")

def cancel_charge_request(call: types.CallbackQuery):
    """Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ø±Ø§ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ù„ØºÙˆ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    uid = call.from_user.id
    admin_msg_ids_str = call.data.split(':')[2]
    admin_msg_ids = admin_msg_ids_str.split('_')
    
    # ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
    _safe_edit(uid, call.message.message_id, escape_markdown("âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯."),
               reply_markup=menu.user_cancel_action("wallet:main", db.get_user_language(uid)))
    
    # ÙˆÛŒØ±Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§
    for msg_id_info in admin_msg_ids:
        try:
            admin_id, msg_id = msg_id_info.split('-')
            original_caption = bot.get_chat(int(admin_id)).photo.caption if bot.get_chat(int(admin_id)).photo else ""
            bot.edit_message_caption(caption=f"{original_caption}\n\nâŒ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ù„ØºÙˆ Ø´Ø¯.",
                                     chat_id=int(admin_id), message_id=int(msg_id))
        except Exception as e:
            logger.warning(f"Could not edit admin message {msg_id_info} upon cancellation: {e}")

def show_wallet_history(call: types.CallbackQuery):
    """ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."""
    uid = call.from_user.id
    history = db.get_wallet_history(uid)
    lang_code = db.get_user_language(uid)
    
    lines = [f"ğŸ“œ *{escape_markdown(get_string('transaction_history', lang_code))}*"]
    if not history:
        lines.append(f"\n{escape_markdown('Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.')}")
    else:
        for trans in history:
            amount = trans['amount']
            trans_type = trans['type']
            emoji = "â•" if trans_type == 'deposit' else "â–"
            amount_str = f"{abs(amount):,.0f}"
            date_str = to_shamsi(trans['transaction_date'], include_time=True)
            description = escape_markdown(trans.get('description', ''))
            
            lines.append(f"`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`\n{emoji} *{amount_str} ØªÙˆÙ…Ø§Ù†* \n`{description}`\n_{escape_markdown(date_str)}_")

    _safe_edit(uid, call.message.message_id, "\n".join(lines),
               reply_markup=menu.user_cancel_action("wallet:main", lang_code))

def confirm_purchase(call: types.CallbackQuery, plan_name: str):
    """Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯."""
    uid = call.from_user.id
    plans = load_service_plans()
    plan_to_buy = next((p for p in plans if p.get('name') == plan_name), None)

    if not plan_to_buy:
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ù¾Ù„Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.", show_alert=True)
        return

    price = plan_to_buy.get('price', 0)
    confirm_text = (
        f"â“ *{escape_markdown('ØªØ§ÛŒÛŒØ¯ Ø®Ø±ÛŒØ¯')}*\n\n"
        f"{escape_markdown('Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÛŒØ¯ Ù¾Ù„Ù† Ø²ÛŒØ± Ù‡Ø³ØªÛŒØ¯:')}\n"
        f"*{escape_markdown(plan_name)}* - {price:,.0f} {escape_markdown('ØªÙˆÙ…Ø§Ù†')}\n\n"
        f"{escape_markdown('Ù…Ø¨Ù„Øº Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ú©Ø³Ø± Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ø¢ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ')}"
    )
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(
        types.InlineKeyboardButton("âœ… Ø¨Ù„Ù‡ØŒ Ø®Ø±ÛŒØ¯", callback_data=f"wallet:buy_execute:{plan_name}"),
        types.InlineKeyboardButton("âŒ Ø§Ù†ØµØ±Ø§Ù", callback_data="view_plans")
    )
    _safe_edit(uid, call.message.message_id, confirm_text, reply_markup=kb)

def execute_purchase(call: types.CallbackQuery, plan_name: str):
    """Ø®Ø±ÛŒØ¯ Ø±Ø§ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø±Ø¯Ù‡ØŒ Ø­Ø¬Ù… Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ùˆ Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú©Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
    uid = call.from_user.id
    plans = load_service_plans()
    plan_to_buy = next((p for p in plans if p.get('name') == plan_name), None)

    if not plan_to_buy:
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ù¾Ù„Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.", show_alert=True)
        return

    price = plan_to_buy.get('price', 0)
    user_uuids = db.uuids(uid)
    if not user_uuids:
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ø´Ù…Ø§ Ù‡ÛŒÚ† Ø§Ú©Ø§Ù†Øª ÙØ¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ù¾Ù„Ù† Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
        
    if db.update_wallet_balance(uid, -price, 'purchase', f"Ø®Ø±ÛŒØ¯ Ù¾Ù„Ù†: {plan_name}"):
        user_main_uuid = user_uuids[0]['uuid']
        add_gb_de = parse_volume_string(plan_to_buy.get('volume_de', '0'))
        add_gb_fr = parse_volume_string(plan_to_buy.get('volume_fr', '0'))
        add_days = parse_volume_string(plan_to_buy.get('duration', '0'))
        
        combined_handler.modify_user_on_all_panels(user_main_uuid, add_gb=add_gb_de, add_days=add_days, target_panel_type='hiddify')
        combined_handler.modify_user_on_all_panels(user_main_uuid, add_gb=add_gb_fr, add_days=add_days, target_panel_type='marzban')
        
        success_text = f"âœ… Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! Ù¾Ù„Ù† *{escape_markdown(plan_name)}* Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ú¯Ø±Ø¯ÛŒØ¯."
        _safe_edit(uid, call.message.message_id, success_text, reply_markup=menu.user_cancel_action("back", db.get_user_language(uid)))
    else:
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ø¯Ø± Ù„Ø­Ø¸Ù‡ Ø¢Ø®Ø± Ú©Ø§ÙÛŒ Ù†Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", show_alert=True)
        from .info import show_plan_categories
        show_plan_categories(call)