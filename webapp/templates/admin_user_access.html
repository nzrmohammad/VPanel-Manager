{% extends "base.html" %}

{% block title %}مدیریت دسترسی و فیلتر کاربران{% endblock %}

{% block extra_css %}
<style>
    /* --- استایل‌های اختصاصی و غیررسپانسیو این صفحه --- */

    /* استایل سوییچ سفارشی */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    /*
      <<<<<<<<<<<<<<<<<<<< START OF CHANGES >>>>>>>>>>>>>>>>>
      استایل‌های زیر از صفحه مدیریت کاربران کپی شده تا ظاهر هدر جدول کاملاً یکسان شود
    */
    .table-header {display: flex;justify-content: space-between;align-items: center;padding: 1rem 1.5rem;gap: 1.5rem;flex-wrap: wrap;border-bottom: 1px solid var(--border-color);}
    .table-filters {display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;}
    .table-filters .filter-group { display: flex; align-items: center; gap: 0.5rem; }
    .table-filters label { font-size: 0.9rem; color: var(--text-secondary); white-space: nowrap; }
    .table-filters select {padding: 0.75rem;border-radius: 8px;border: 1px solid var(--border-color);background-color: var(--bg-color);color: var(--text-color);-webkit-appearance: none;-moz-appearance: none;appearance: none;background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position: left 0.5rem center;background-repeat: no-repeat;background-size: 1.5em 1.5em;padding-left: 2.5rem;}
    body.dark-theme .table-filters select {background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");}

    /* استایل واکنش‌گرایی برای فیلترها در موبایل */
    @media (max-width: 767px) {
        .table-filters {
            display: grid;
            grid-template-columns: 1fr 1fr; /* ایجاد دو ستون مساوی */
            gap: 1rem;
            width: 100%;
        }
        .table-filters .filter-group {
            width: 100%; /* هر گروه فیلتر عرض کامل ستون خود را بگیرد */
        }
        .table-filters .filter-group select {
            width: 100%; /* سلکت باکس هم عرض کامل بگیرد */
        }
    }
    /* <<<<<<<<<<<<<<<<<<<< END OF CHANGES >>>>>>>>>>>>>>>> */

</style>
{% endblock %}

{% block page_content %}
    {% set page_title='مدیریت دسترسی کاربران' %}
    {% include 'partials/_header.html' %}

    <div class="info-card data-table-container" id="user-access-management">
    <div class="table-header">
        <div class="search-box">
            <i class="ri-search-line"></i>
            <input type="text" id="searchInput" placeholder="جستجوی کاربر یا نام کانفیگ...">
        </div>
        <div class="table-filters">
            <div class="filter-group">
                <label for="vipFilter">وضعیت:</label>
                <select id="vipFilter">
                    <option value="all">همه</option>
                    <option value="vip">فقط VIP</option>
                    <option value="normal">کاربران عادی</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="serverFilter">سرور:</label>
                <select id="serverFilter">
                    <option value="all">همه</option>
                    <option value="de">شامل آلمان 🇩🇪</option>
                    <option value="fr">شامل فرانسه 🇫🇷</option>
                    <option value="tr">شامل ترکیه 🇹🇷</option>
                    <option value="us">شامل آمریکا 🇺🇸</option>
                    <option value="ro">شامل رومانی 🇷🇴</option>
                </select>
            </div>
        </div>
    </div>
    <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>کاربر تلگرام</th>
                        <th>نام کاربر (در پنل)</th>
                        <th>پنل‌های فعال</th>
                        <th>VIP ⭐</th>
                        <th>آلمان 🇩🇪</th>
                        <th>فرانسه 🇫🇷</th>
                        <th>ترکیه 🇹🇷</th>
                        <th>آمریکا 🇺🇸</th>
                        <th>رومانی 🇷🇴</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    {% for user in bot_users %}
                        <tr data-uuid-id="{{ user.uuid_id }}" data-uuid="{{ user.uuid }}">
                            <td><span>{{ user.first_name or 'کاربر' }} (<code>{{ user.user_id }}</code>)</span></td>
                            <td><span>{{ user.config_name }}</span></td>
                            <td class="panel-display-cell">
                                <span style="font-size: 1.1em;">
                                    {% if user.has_access_de %}🇩🇪{% endif %}
                                    {% if user.has_access_fr %}🇫🇷{% endif %}
                                    {% if user.has_access_tr %}🇹🇷{% endif %}
                                    {% if user.has_access_us %}🇺🇸{% endif %}
                                    {% if user.has_access_ro %}🇷🇴{% endif %}
                                </span>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="toggle-vip" {% if user.is_vip %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="de" {% if user.has_access_de %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="fr" {% if user.has_access_fr %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="tr" {% if user.has_access_tr %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="us" {% if user.has_access_us %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="ro" {% if user.has_access_ro %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                        </tr>
                    {% else %}
                        <tr><td colspan="8" style="text-align: center; padding: 1.5rem;">هیچ کاربری در ربات ثبت‌نام نکرده است.</td></tr>
                    {% endfor %}
                    <tr id="no-results-row" style="display: none;"><td colspan="8" style="text-align: center; padding: 1.5rem;">هیچ کاربری با این مشخصات یافت نشد.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = '{{ csrf_token() }}';
    const tableBody = document.getElementById('user-table-body');
    const searchInput = document.getElementById('searchInput');
    const vipFilter = document.getElementById('vipFilter');
    const serverFilter = document.getElementById('serverFilter');
    const noResultsRow = document.getElementById('no-results-row');

    function filterAndSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const vipStatus = vipFilter.value;
        const serverAccess = serverFilter.value;
        let visibleCount = 0;

        tableBody.querySelectorAll('tr[data-uuid]').forEach(row => {
            const userName = row.cells[0].textContent.toLowerCase();
            const configName = row.cells[1].textContent.toLowerCase();
            const isVip = row.querySelector('.toggle-vip').checked;
            
            const searchMatch = userName.includes(searchTerm) || configName.includes(searchTerm);
            const vipMatch = (vipStatus === 'all') || (vipStatus === 'vip' && isVip) || (vipStatus === 'normal' && !isVip);
            const serverMatch = (serverAccess === 'all') || (row.querySelector(`.access-toggle[data-server="${serverAccess}"]`).checked);

            if (searchMatch && vipMatch && serverMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
    }

    let debounceTimer;
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(filterAndSearch, 300);
    });
    vipFilter.addEventListener('change', filterAndSearch);
    serverFilter.addEventListener('change', filterAndSearch);

    tableBody.addEventListener('change', function(e) {
        const checkbox = e.target;
        if (!checkbox.matches('.access-toggle, .toggle-vip')) return;

        const row = checkbox.closest('tr');
        checkbox.disabled = true;

        if (checkbox.classList.contains('access-toggle')) {
            const uuidId = row.dataset.uuidId;
            const server = checkbox.dataset.server;
            const status = checkbox.checked;
            fetch('/admin/api/users/toggle_access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ uuid_id: parseInt(uuidId), server, status })
            }).catch(err => console.error(err)).finally(() => { checkbox.disabled = false; });
        } else if (checkbox.classList.contains('toggle-vip')) {
            const uuid = row.dataset.uuid;
            const originalState = !checkbox.checked;
            fetch(`/admin/api/users/toggle_vip/${uuid}`, {
                method: 'POST',
                headers: { 'X-CSRF-Token': csrfToken }
            }).then(res => res.ok ? res.json() : Promise.reject(res))
            .then(data => { if (!data.success) throw new Error(data.message); showToast(data.message, true); })
            .catch(err => { showToast('خطا در به‌روزرسانی وضعیت', false); checkbox.checked = originalState; })
            .finally(() => { checkbox.disabled = false; });
        }
    });

    function showToast(message, isSuccess) {
        // A simple toast notification function, you can replace with a more robust library
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.right = '20px';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '8px';
        toast.style.backgroundColor = isSuccess ? '#28a745' : '#dc3545';
        toast.style.color = 'white';
        toast.style.zIndex = '1050';
        document.body.appendChild(toast);
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 3000);
    }
});
</script>
{% endblock %}