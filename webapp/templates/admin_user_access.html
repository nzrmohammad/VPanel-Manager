{% extends "base.html" %}

{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ Ùˆ ÙÛŒÙ„ØªØ± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†{% endblock %}

{% block extra_css %}
<style>
    /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ø§ÛŒÙ† ØµÙØ­Ù‡ (Ø¨Ø±Ú¯Ø±ÙØªÙ‡ Ø§Ø² style.css Ùˆ responsive.css) --- */
    
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø³ÙˆÛŒÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø®Ø´ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ (Ø¬Ø³ØªØ¬Ùˆ Ùˆ ÙÛŒÙ„ØªØ±) */
    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    .search-box {
        position: relative;
        flex-grow: 1;
        min-width: 280px;
    }
    .search-box input {
        width: 100%;
        padding: 9px 12px 9px 40px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-box input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.2);
    }
    .search-box .ri-search-line {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.2rem;
    }
    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .filter-group label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    .filter-group select {
        padding: 9px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
    }

    /* ÙˆØ§Ú©Ù†Ø´Ú¯Ø±Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
    @media (max-width: 767px) {
        .table-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        /* --- Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ú©Ù†Ø´Ú¯Ø±Ø§ --- */
        .data-table thead { display: none; }
        .data-table tr { display: block; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 1rem; padding: 0.75rem; }
        .data-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px dashed var(--border-color); text-align: left !important; }
        .data-table td:last-child { border-bottom: none; }
        .data-table td::before { font-weight: bold; color: var(--text-secondary); }

        /* Ø§ØµÙ„Ø§Ø­ ØªØ±ØªÛŒØ¨ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        .data-table td:nth-of-type(1)::before { content: 'Ú©Ø§Ø±Ø¨Ø±'; }
        .data-table td:nth-of-type(2)::before { content: 'Ù†Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯'; }
        .data-table td:nth-of-type(3)::before { content: 'Ù¾Ù†Ù„â€ŒÙ‡Ø§'; }
        .data-table td:nth-of-type(4)::before { content: 'VIP â­'; } /* Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯ */
        .data-table td:nth-of-type(5)::before { content: 'Ø¢Ù„Ù…Ø§Ù† ğŸ‡©ğŸ‡ª'; }
        .data-table td:nth-of-type(6)::before { content: 'ÙØ±Ø§Ù†Ø³Ù‡ ğŸ‡«ğŸ‡·'; }
        .data-table td:nth-of-type(7)::before { content: 'ØªØ±Ú©ÛŒÙ‡ ğŸ‡¹ğŸ‡·'; }
    }
</style>
{% endblock %}

{% block page_content %}
    {% set page_title='Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†' %}
    {% include 'partials/_header.html' %}

    <div class="info-card data-table-container">
        <!-- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ø¬Ø³ØªØ¬Ùˆ Ùˆ ÙÛŒÙ„ØªØ± -->
        <div class="table-controls">
            <div class="search-box">
                <i class="ri-search-line"></i>
                <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ Ù†Ø§Ù… Ú©Ø§Ù†ÙÛŒÚ¯...">
            </div>
            <div class="filter-group">
                <label for="vipFilter">ÙˆØ¶Ø¹ÛŒØª VIP:</label>
                <select id="vipFilter">
                    <option value="all">Ù‡Ù…Ù‡</option>
                    <option value="vip">ÙÙ‚Ø· VIP</option>
                    <option value="normal">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="serverFilter">Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÙˆØ±:</label>
                <select id="serverFilter">
                    <option value="all">Ù‡Ù…Ù‡</option>
                    <option value="de">Ø´Ø§Ù…Ù„ Ø¢Ù„Ù…Ø§Ù† ğŸ‡©ğŸ‡ª</option>
                    <option value="fr">Ø´Ø§Ù…Ù„ ÙØ±Ø§Ù†Ø³Ù‡ ğŸ‡«ğŸ‡·</option>
                    <option value="tr">Ø´Ø§Ù…Ù„ ØªØ±Ú©ÛŒÙ‡ ğŸ‡¹ğŸ‡·</option>
                </select>
            </div>
        </div>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ú©Ø§Ø±Ø¨Ø± ØªÙ„Ú¯Ø±Ø§Ù…</th>
                        <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± (Ø¯Ø± Ù¾Ù†Ù„)</th>
                        <th>Ù¾Ù†Ù„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</th>
                        <th>VIP â­</th>
                        <th>Ø¢Ù„Ù…Ø§Ù† ğŸ‡©ğŸ‡ª</th>
                        <th>ÙØ±Ø§Ù†Ø³Ù‡ ğŸ‡«ğŸ‡·</th>
                        <th>ØªØ±Ú©ÛŒÙ‡ ğŸ‡¹ğŸ‡·</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    {% for user in bot_users %}
                        <tr data-uuid-id="{{ user.uuid_id }}" data-uuid="{{ user.uuid }}">
                            <td>{{ user.first_name or 'Ú©Ø§Ø±Ø¨Ø±' }} (<code>{{ user.user_id }}</code>)</td>
                            <td>{{ user.config_name }}</td>
                            <td class="panel-display-cell">ğŸ‡©ğŸ‡ª {% if user.is_on_marzban %}ğŸ‡«ğŸ‡·{% endif %}</td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="toggle-vip" {% if user.is_vip %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="de" {% if user.has_access_de %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="fr" {% if user.has_access_fr %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="tr" {% if user.has_access_tr %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                        </tr>
                    {% else %}
                        <tr><td colspan="7" class="text-center py-4">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.</td></tr>
                    {% endfor %}
                    <tr id="no-results-row" style="display: none;"><td colspan="7" class="text-center py-4">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ù†Ø§ØµØ± ---
    const csrfToken = '{{ csrf_token() }}';
    const tableBody = document.getElementById('user-table-body');
    const searchInput = document.getElementById('searchInput');
    const vipFilter = document.getElementById('vipFilter');
    const serverFilter = document.getElementById('serverFilter');
    const noResultsRow = document.getElementById('no-results-row');

    // --- ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ ---
    function filterAndSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const vipStatus = vipFilter.value;
        const serverAccess = serverFilter.value;
        let visibleCount = 0;

        tableBody.querySelectorAll('tr[data-uuid]').forEach(row => {
            const userName = row.cells[0].textContent.toLowerCase();
            const configName = row.cells[1].textContent.toLowerCase();
            const isVip = row.querySelector('.toggle-vip').checked;
            
            const searchMatch = userName.includes(searchTerm) || configName.includes(searchTerm);
            const vipMatch = (vipStatus === 'all') || (vipStatus === 'vip' && isVip) || (vipStatus === 'normal' && !isVip);
            const serverMatch = (serverAccess === 'all') || (row.querySelector(`.access-toggle[data-server="${serverAccess}"]`).checked);

            if (searchMatch && vipMatch && serverMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
    }

    // --- Ø§ØªØµØ§Ù„ Event Listener Ù‡Ø§ ---
    let debounceTimer;
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(filterAndSearch, 300);
    });
    vipFilter.addEventListener('change', filterAndSearch);
    serverFilter.addEventListener('change', filterAndSearch);

    // --- Ù…Ù†Ø·Ù‚ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø³ÙˆÛŒÛŒÚ†â€ŒÙ‡Ø§ ---
  // --- Ù…Ù†Ø·Ù‚ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø³ÙˆÛŒÛŒÚ†â€ŒÙ‡Ø§ (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ) ---
    tableBody.addEventListener('change', function(e) {
        const checkbox = e.target;
        if (!checkbox.matches('.access-toggle, .toggle-vip')) return;

        const row = checkbox.closest('tr');
        checkbox.disabled = true;

        if (checkbox.classList.contains('access-toggle')) {
            const uuidId = row.dataset.uuidId;
            const server = checkbox.dataset.server;
            const status = checkbox.checked;
            fetch('/admin/api/users/toggle_access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ uuid_id: parseInt(uuidId), server, status })
            }).catch(err => console.error(err)).finally(() => { checkbox.disabled = false; });
        } else if (checkbox.classList.contains('toggle-vip')) {
            const uuid = row.dataset.uuid;
            const originalState = !checkbox.checked;
            fetch(`/admin/api/users/toggle_vip/${uuid}`, {
                method: 'POST',
                headers: { 'X-CSRF-Token': csrfToken }
            }).then(res => res.ok ? res.json() : Promise.reject(res))
            .then(data => { if (!data.success) throw new Error(data.message); showToast(data.message, true); })
            .catch(err => { showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª', false); checkbox.checked = originalState; })
            .finally(() => { checkbox.disabled = false; });
        }
    });

        // ... (Ú©Ø¯ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙˆÛŒÛŒÚ†â€ŒÙ‡Ø§ Ø§Ø² Ù¾Ø§Ø³Ø® Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
    });
</script>
{% endblock %}
