{% extends "base.html" %}

{% block title %}مدیریت دسترسی و فیلتر کاربران{% endblock %}

{% block extra_css %}
<style>
    /* --- استایل‌های اختصاصی این صفحه (برگرفته از style.css و responsive.css) --- */
    
    /* استایل سوییچ سفارشی */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* استایل بخش کنترل‌ها (جستجو و فیلتر) */
    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    .search-box {
        position: relative;
        flex-grow: 1;
        min-width: 280px;
    }
    .search-box input {
        width: 100%;
        padding: 9px 12px 9px 40px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-box input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.2);
    }
    .search-box .ri-search-line {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.2rem;
    }
    .filter-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .filter-group label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    .filter-group select {
        padding: 9px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
    }

    /* واکنشگرایی برای موبایل */
    @media (max-width: 767px) {
        .table-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        /* --- برچسب‌های جدول واکنشگرا --- */
        .data-table thead { display: none; }
        .data-table tr { display: block; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 1rem; padding: 0.75rem; }
        .data-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px dashed var(--border-color); text-align: left !important; }
        .data-table td:last-child { border-bottom: none; }
        .data-table td::before { font-weight: bold; color: var(--text-secondary); }

        /* اصلاح ترتیب ستون‌ها برای نمایش در موبایل */
        .data-table td:nth-of-type(1)::before { content: 'کاربر'; }
        .data-table td:nth-of-type(2)::before { content: 'نام کانفیگ'; }
        .data-table td:nth-of-type(3)::before { content: 'پنل‌ها'; }
        .data-table td:nth-of-type(4)::before { content: 'VIP ⭐'; } /* ستون جدید */
        .data-table td:nth-of-type(5)::before { content: 'آلمان 🇩🇪'; }
        .data-table td:nth-of-type(6)::before { content: 'فرانسه 🇫🇷'; }
        .data-table td:nth-of-type(7)::before { content: 'ترکیه 🇹🇷'; }
    }
</style>
{% endblock %}

{% block page_content %}
    {% set page_title='مدیریت دسترسی کاربران' %}
    {% include 'partials/_header.html' %}

    <div class="info-card data-table-container">
        <!-- بخش جدید: جستجو و فیلتر -->
        <div class="table-controls">
            <div class="search-box">
                <i class="ri-search-line"></i>
                <input type="text" id="searchInput" placeholder="جستجوی کاربر یا نام کانفیگ...">
            </div>
            <div class="filter-group">
                <label for="vipFilter">وضعیت VIP:</label>
                <select id="vipFilter">
                    <option value="all">همه</option>
                    <option value="vip">فقط VIP</option>
                    <option value="normal">کاربران عادی</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="serverFilter">دسترسی سرور:</label>
                <select id="serverFilter">
                    <option value="all">همه</option>
                    <option value="de">شامل آلمان 🇩🇪</option>
                    <option value="fr">شامل فرانسه 🇫🇷</option>
                    <option value="tr">شامل ترکیه 🇹🇷</option>
                </select>
            </div>
        </div>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>کاربر تلگرام</th>
                        <th>نام کاربر (در پنل)</th>
                        <th>پنل‌های فعال</th>
                        <th>VIP ⭐</th>
                        <th>آلمان 🇩🇪</th>
                        <th>فرانسه 🇫🇷</th>
                        <th>ترکیه 🇹🇷</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    {% for user in bot_users %}
                        <tr data-uuid-id="{{ user.uuid_id }}" data-uuid="{{ user.uuid }}">
                            <td>{{ user.first_name or 'کاربر' }} (<code>{{ user.user_id }}</code>)</td>
                            <td>{{ user.config_name }}</td>
                            <td class="panel-display-cell">🇩🇪 {% if user.is_on_marzban %}🇫🇷{% endif %}</td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="toggle-vip" {% if user.is_vip %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="de" {% if user.has_access_de %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="fr" {% if user.has_access_fr %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                            <td class="access-toggle-cell">
                                <label class="switch"><input type="checkbox" class="access-toggle" data-server="tr" {% if user.has_access_tr %}checked{% endif %}><span class="slider"></span></label>
                            </td>
                        </tr>
                    {% else %}
                        <tr><td colspan="7" class="text-center py-4">هیچ کاربری در ربات ثبت‌نام نکرده است.</td></tr>
                    {% endfor %}
                    <tr id="no-results-row" style="display: none;"><td colspan="7" class="text-center py-4">هیچ کاربری با این مشخصات یافت نشد.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- انتخاب عناصر ---
    const csrfToken = '{{ csrf_token() }}';
    const tableBody = document.getElementById('user-table-body');
    const searchInput = document.getElementById('searchInput');
    const vipFilter = document.getElementById('vipFilter');
    const serverFilter = document.getElementById('serverFilter');
    const noResultsRow = document.getElementById('no-results-row');

    // --- تابع اصلی فیلتر و جستجو ---
    function filterAndSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const vipStatus = vipFilter.value;
        const serverAccess = serverFilter.value;
        let visibleCount = 0;

        tableBody.querySelectorAll('tr[data-uuid]').forEach(row => {
            const userName = row.cells[0].textContent.toLowerCase();
            const configName = row.cells[1].textContent.toLowerCase();
            const isVip = row.querySelector('.toggle-vip').checked;
            
            const searchMatch = userName.includes(searchTerm) || configName.includes(searchTerm);
            const vipMatch = (vipStatus === 'all') || (vipStatus === 'vip' && isVip) || (vipStatus === 'normal' && !isVip);
            const serverMatch = (serverAccess === 'all') || (row.querySelector(`.access-toggle[data-server="${serverAccess}"]`).checked);

            if (searchMatch && vipMatch && serverMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
    }

    // --- اتصال Event Listener ها ---
    let debounceTimer;
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(filterAndSearch, 300);
    });
    vipFilter.addEventListener('change', filterAndSearch);
    serverFilter.addEventListener('change', filterAndSearch);

    // --- منطق مربوط به سوییچ‌ها ---
  // --- منطق مربوط به سوییچ‌ها (کد قبلی) ---
    tableBody.addEventListener('change', function(e) {
        const checkbox = e.target;
        if (!checkbox.matches('.access-toggle, .toggle-vip')) return;

        const row = checkbox.closest('tr');
        checkbox.disabled = true;

        if (checkbox.classList.contains('access-toggle')) {
            const uuidId = row.dataset.uuidId;
            const server = checkbox.dataset.server;
            const status = checkbox.checked;
            fetch('/admin/api/users/toggle_access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ uuid_id: parseInt(uuidId), server, status })
            }).catch(err => console.error(err)).finally(() => { checkbox.disabled = false; });
        } else if (checkbox.classList.contains('toggle-vip')) {
            const uuid = row.dataset.uuid;
            const originalState = !checkbox.checked;
            fetch(`/admin/api/users/toggle_vip/${uuid}`, {
                method: 'POST',
                headers: { 'X-CSRF-Token': csrfToken }
            }).then(res => res.ok ? res.json() : Promise.reject(res))
            .then(data => { if (!data.success) throw new Error(data.message); showToast(data.message, true); })
            .catch(err => { showToast('خطا در به‌روزرسانی وضعیت', false); checkbox.checked = originalState; })
            .finally(() => { checkbox.disabled = false; });
        }
    });

        // ... (کد جاوااسکریپت برای مدیریت سوییچ‌ها از پاسخ قبلی بدون تغییر باقی می‌ماند)
    });
</script>
{% endblock %}
