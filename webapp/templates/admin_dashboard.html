{% extends "base.html" %}

{% block title %} داشبورد {% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; align-items: flex-start; }
    .main-column, .sidebar-column { display: flex; flex-direction: column; gap: 1.5rem; }
    .user-list .usage { color: var(--accent-color); font-weight: 500; }
    
    .user-list.multi-column { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
        gap: 0.25rem 1.5rem; 
        padding: 0.5rem 1.25rem; 
    }
    .user-list.multi-column .user-list-item { 
        padding: 0.5rem 0; 
        border-bottom: 1px solid var(--border-color); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    .user-list.multi-column .user-list-item:nth-last-child(-n+2) { 
        border-bottom: none; 
    }
    
    .rtl-fix-list .user-list-item {
        direction: ltr;
        text-align: right;
    }
    .rtl-fix-list .user-list-item > span:first-child {
        text-align: left;
        margin-right: auto;
    }

    .online-users-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding-top: 1rem; }
    .online-users-grid h4 { text-align: center; margin-bottom: 1rem; color: var(--text-color-secondary); }
    .online-users-grid .user-list { padding: 0 1rem; }
    .health-status-list .status { font-weight: 500; }
    .health-status-list .status.ok { color: #22c55e; }
    .health-status-list .status.error { color: #ef4444; }
    .chart-card-header {display:flex; align-items:center; gap:0.75rem;}
    .chart-card-header .icon {margin-bottom:0;}
    
    .make-two-column {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.25rem 1.5rem;
    }
    .online-users-grid .user-list-item {
        justify-content: center;
    }
</style>
{% endblock %}

{% block page_content %}

    {% set page_title='داشبورد' %}
    {% include 'partials/_header.html' %}

    <section class="info-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 1.5rem;">
        <div class="info-card"><div class="card-header"><i class="ri-group-line icon"></i><span>کل کاربران</span></div><div class="card-content">{{ stats.total_users | default('...') }}</div></div>
        <a href="{{ url_for('admin.user_management_page', filter='active') }}" class="info-card clickable"><div class="card-header"><i class="ri-user-follow-line icon"></i><span>کاربران فعال</span></div><div class="card-content">{{ stats.active_users | default('...') }}</div></a>
        <a href="{{ url_for('admin.user_management_page', filter='online') }}" class="info-card clickable"><div class="card-header"><i class="ri-wifi-line icon"></i><span>آنلاین (۳دقیقه)</span></div><div class="card-content">{{ stats.online_users | default('...') }}</div></a>
        <div class="info-card"><div class="card-header"><i class="ri-download-cloud-2-line icon"></i><span>مصرف امروز</span></div><div class="card-content">{{ stats.total_usage_today | default('...') }}</div></div>
        <div class="info-card"><div class="card-header"><i class="ri-user-add-line icon"></i><span>کاربران جدید امروز</span></div><div class="card-content">{{ stats.new_users_last_24h_count | default('...') }}</div></div>
        <div class="info-card"><div class="card-header"><i class="ri-money-dollar-circle-line icon"></i><span>پرداخت‌های امروز</span></div><div class="card-content">{{ stats.payments_today | default('0') }}</div></div>
        <div class="info-card"><div class="card-header"><i class="ri-vip-crown-fill icon"></i><span>کاربران VIP</span></div><div class="card-content">{{ stats.vip_users | default('0') }}</div></div>
    </section>
    
    <div class="dashboard-grid">
        <div class="main-column">
            <section class="info-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                <div class="info-card">
                    <div class="card-header"><i class="ri-heart-pulse-line icon"></i><span>وضعیت سلامت سیستم</span></div>
                    <ul class="user-list health-status-list multi-column rtl-fix-list">
                        {% for service_name, status in system_health.items() %}
                        <li class="user-list-item">
                            <span>{{ service_name }}</span>
                            {% if status and status.ok %}
                                <span class="status ok">✅</span>
                            {% else %}
                                <span class="status error" title="خطا: {{ status.error if status else 'نامشخص' }}">❌</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="info-card">
                    <div class="card-header"><i class="ri-user-add-line icon"></i><span>کاربران جدید</span></div>
                    <ul class="user-list multi-column rtl-fix-list">
                        {% for user in new_users_last_24h %}
                            <li class="user-list-item">
                                <span>{{ user.name }}</span>
                                <span class="date">{{ user.created_at | to_shamsi(include_time=False) if user.created_at }}</span>
                            </li>
                        {% else %}
                            <li style="grid-column: 1 / -1;">کاربر جدیدی یافت نشد.</li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="info-card">
                    <div class="card-header"><i class="ri-gift-line icon"></i><span>تولدهای نزدیک</span></div>
                    <ul class="user-list multi-column rtl-fix-list">
                    {% set upcoming_birthdays = users_with_birthdays | selectattr('days_to_birthday', 'le', 7) | list %}
                    {% for user in upcoming_birthdays %}
                        <li class="user-list-item">
                        <span>{{ user.name }}</span>
                        <span class="days">
                            {% if user.days_to_birthday == 0 %}
                                <strong style="color: var(--success-color);">🎉 امروز!</strong>
                            {% else %}
                                {{ user.days_to_birthday }} روز دیگر
                            {% endif %}
                        </span>
                        </li>
                    {% else %}
                        <li style="grid-column: 1 / -1;">کاربری با تولد نزدیک یافت نشد.</li>
                    {% endfor %}
                    </ul>
                </div>
            </section>
            
            <div class="info-card">
                <div class="chart-card-header" style="margin-bottom: 1.5rem;">
                  <i class="ri-bar-chart-line icon"></i>
                  <span>نمودار مجموع مصرف هفتگی کاربران (GB)</span>
                </div>
                <div id="usage-chart"></div>
            </div>

            <div class="info-card">
                <div class="chart-card-header" style="margin-bottom: 1.5rem;">
                  <i class="ri-line-chart-line icon"></i>
                  <span>مقایسه مصرف روزانه پنل‌ها (GB)</span>
                </div>
                <div id="usage-comparison-chart"></div>
            </div>

            <div class="info-card">
                <div class="chart-card-header"><i class="ri-wifi-line icon"></i><span>لیست کاربران آنلاین فعلی</span></div>
                <div class="online-users-grid">
                    <div>
                        <h4 style="text-align: center;">Hiddify 🇩🇪</h4>
                        <ul class="user-list make-two-column ltr-list">
                            {% for user in online_users_hiddify %}<li class="user-list-item"><span>{{ user.name }}</span></li>{% else %}<li>-</li>{% endfor %}
                        </ul>
                    </div>
                    <div>
                        <h4 style="text-align: center;">Marzban 🇫🇷</h4>
                        <ul class="user-list make-two-column ltr-list">
                            {% for user in online_users_marzban %}<li class="user-list-item"><span>{{ user.name }}</span></li>{% else %}<li>-</li>{% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar-column">
            <div class="info-card">
                <div class="card-header"><i class="ri-time-line icon"></i><span>در آستانه انقضا</span></div>
                <ul class="user-list multi-column rtl-fix-list" id="expiring-soon-list">
                    {% for user in expiring_soon_users %}
                        <li class="user-list-item" data-expire-days="{{ user.expire }}">
                            <span>{{ user.name }}</span>
                            <span class="days"></span>
                        </li>
                    {% else %}
                        <li style="grid-column: 1 / -1;">کاربری یافت نشد.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="info-card">
              <div class="chart-card-header" style="margin-bottom: 1rem;">
                <i class="ri-fire-line icon"></i>
                <span>پرمصرف‌ترین‌های امروز (GB)</span>
              </div>
              {% if top_consumers_chart_data and top_consumers_chart_data.data %}
                <div id="top-consumers-chart" style="min-height: 320px;"></div>
              {% else %}
                <div style="text-align: center; padding: 2rem 0; color: var(--text-color-secondary);">هنوز مصرفی ثبت نشده.</div>
              {% endif %}
            </div>
            <div class="info-card">
                <div class="chart-card-header">
                  <i class="ri-pie-chart-2-line icon"></i>
                  <span>تفکیک کاربران فعال</span>
                </div>
                <div id="active-users-dist-chart" style="min-height: 280px;"></div>
            </div>
            <div class="info-card">
                <div class="chart-card-header">
                  <i class="ri-pie-chart-line icon"></i>
                  <span>توزیع پلن‌های کاربران</span>
                </div>
                <div id="plan-distribution-chart" style="min-height: 280px;"></div>
            </div>
            <div class="info-card">
                <div class="chart-card-header">
                  <i class="ri-calendar-todo-line icon"></i>
                  <span>وضعیت انقضای کاربران</span>
                </div>
                <div id="expiration-chart" style="min-height: 280px;"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    let usageChart, topConsumersChart, activeUsersDistChart, expirationChart, planDistChart, usageComparisonChart;

    const renderOrUpdateCharts = () => {
        const isDarkTheme = document.body.classList.contains('dark-theme');
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();

        const getThemeOptions = (options = {}) => {
            const axisColor = isDarkTheme ? '#9ca3af' : '#6b7280';
            return {
                chart: { fontFamily: 'Vazirmatn, sans-serif', background: 'transparent', toolbar: { show: false }, ...(options.chart || {}) },
                theme: { mode: isDarkTheme ? 'dark' : 'light' },
                tooltip: { theme: isDarkTheme ? 'dark' : 'light' },
                xaxis: { labels: { style: { colors: axisColor } }, axisBorder: { show: false }, axisTicks: { show: false } },
                yaxis: { labels: { style: { colors: axisColor }, offsetX: -10 }, title: { style: { color: axisColor, fontWeight: 400 } } },
                grid: { borderColor: isDarkTheme ? '#374151' : '#e5e7eb' },
                legend: { labels: { colors: isDarkTheme ? '#f9fafb' : '#111827' } }
            };
        };

        const initOrUpdate = (chartInstance, selector, options) => {
            const container = document.querySelector(selector);
            if (!container) return chartInstance;
            if (chartInstance) {
                chartInstance.updateOptions(options);
            } else {
                chartInstance = new ApexCharts(container, options);
                chartInstance.render();
            }
            return chartInstance;
        };

        // --- Usage Chart ---
        const usageChartData = {{ usage_chart_data | tojson | safe }};
        const usageChartOptions = {
            ...getThemeOptions({ chart: { type: 'area', height: 250, zoom: { enabled: false }, parentHeightOffset: 15, padding: { left: 10, right: 0 } } }),
            series: [{ name: "مجموع کل مصرف", data: usageChartData.data }],
            fill: { type: "gradient", gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] } },
            colors: [accentColor],
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            xaxis: { categories: usageChartData.labels },
            yaxis: { labels: { formatter: (val) => val.toFixed(0) }, title: { text: '(GB)', rotate: 0, offsetX: 10, style: { fontSize: '10px' } } },
            tooltip: { y: { formatter: (val) => `${val.toFixed(2)} GB` } }
        };
        usageChart = initOrUpdate(usageChart, "#usage-chart", usageChartOptions);

        // --- NEW: Usage Comparison Chart ---
        const usageCompData = {{ usage_comparison_chart_data | tojson | safe }};
        const usageCompOptions = {
            ...getThemeOptions({ chart: { type: 'area', height: 250, stacked: true, zoom: { enabled: false } } }),
            series: usageCompData.series,
            colors: ['#008FFB', '#00E396'],
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            fill: { type: 'gradient', gradient: { opacityFrom: 0.6, opacityTo: 0.1 } },
            xaxis: { type: 'category', categories: usageCompData.labels },
            yaxis: { title: { text: 'حجم مصرف (GB)' } },
            legend: { position: 'top', horizontalAlign: 'center' }
        };
        usageComparisonChart = initOrUpdate(usageComparisonChart, "#usage-comparison-chart", usageCompOptions);

        // --- Top Consumers Chart ---
        const topConsumersData = {{ (top_consumers_chart_data or {"labels": [], "data": []}) | tojson | safe }};
        if (topConsumersData.data.length > 0) {
            const barHeight = Math.max(220, topConsumersData.labels.length * 44);
            const topConsumersOptions = {
                ...getThemeOptions({ chart: { type: 'bar', height: barHeight } }),
                series: [{ name: 'مصرف امروز', data: topConsumersData.data.slice(0, 10).reverse() }],
                plotOptions: { bar: { borderRadius: 4, horizontal: true, barHeight: '60%', dataLabels: { position: 'top' } } },
                colors: [accentColor],
                dataLabels: { enabled: true, formatter: (val) => val.toFixed(2) + " GB", offsetX: 40, style: { fontSize: '12px', colors: [isDarkTheme ? '#f9fafb' : '#111827'] } },
                stroke: { show: true, width: 1, colors: ['transparent'] },
                xaxis: { categories: topConsumersData.labels.slice(0, 10).reverse(), title: { text: 'مصرف (GB)' } },
                yaxis: { labels: { fontSize: '13px' } },
                legend: { show: false }
            };
            topConsumersChart = initOrUpdate(topConsumersChart, "#top-consumers-chart", topConsumersOptions);
        }

        // --- Active Users by Panel Chart ---
        const activeUsersDistData = {{ panel_distribution_data | tojson | safe }};
        const activeUsersDistOptions = {
            ...getThemeOptions({ chart: { type: 'donut', height: 280 } }),
            series: activeUsersDistData.series,
            labels: activeUsersDistData.labels,
            colors: ['#008FFB', '#00E396', '#FEB019'],
            plotOptions: { pie: { donut: { size: '65%', labels: { show: true, name: { offsetY: -10 }, value: { offsetY: 5, formatter: (val) => val + " نفر" }, total: { show: true, label: 'کل کاربران فعال', formatter: () => {{ stats.active_users | default(0) }} + " نفر" } } } } },
            dataLabels: { enabled: false },
            legend: { position: 'bottom' },
            tooltip: { y: { formatter: (val) => val + " کاربر فعال" } },
            stroke: { show: false }
        };
        activeUsersDistChart = initOrUpdate(activeUsersDistChart, "#active-users-dist-chart", activeUsersDistOptions);

        // --- Plan Distribution Chart ---
        const planDistData = {{ plan_distribution_chart_data | tojson | safe }};
        const planDistOptions = {
            ...getThemeOptions({ chart: { type: 'donut', height: 280 } }),
            series: planDistData.series,
            labels: planDistData.labels,
            plotOptions: { pie: { donut: { size: '65%', labels: { show: true, name: { offsetY: -10 }, value: { offsetY: 5, formatter: (val) => val + " نفر" }, total: { show: true, label: 'کل کاربران', formatter: () => {{ stats.total_users | default(0) }} + " نفر" } } } } },
            dataLabels: { enabled: false },
            legend: { position: 'bottom' },
            tooltip: { y: { formatter: (val) => val + " کاربر" } }
        };
        planDistChart = initOrUpdate(planDistChart, "#plan-distribution-chart", planDistOptions);

        // --- Expiration Chart ---
        const expData = {{ expiration_chart_data | tojson | safe }};
        const expOptions = {
            ...getThemeOptions({ chart: { type: 'bar', height: 280 } }),
            series: expData.series,
            plotOptions: { bar: { borderRadius: 4, horizontal: false, distributed: true } },
            dataLabels: { enabled: false },
            xaxis: { categories: expData.labels },
            yaxis: { title: { text: 'تعداد کاربران' } },
            legend: { show: false },
            tooltip: { y: { formatter: (val) => val + ' کاربر' } }
        };
        expirationChart = initOrUpdate(expirationChart, "#expiration-chart", expOptions);
    };

    getPersianDayString = (days) => {
        if (days === 0) return `<span style="color: var(--danger-color); font-weight: bold;">امروز</span>`;
        if (days > 0 && days <= 7) return `<span>${["یک", "دو", "سه", "چهار", "پنج", "شش", "هفت"][days - 1]} روز</span>`;
        return `<span>${days} روز</span>`;
    }
    document.querySelectorAll('#expiring-soon-list .user-list-item').forEach(item => {
        item.querySelector('.days').innerHTML = getPersianDayString(parseInt(item.dataset.expireDays, 10));
    });

    renderOrUpdateCharts();

    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            setTimeout(renderOrUpdateCharts, 150);
        });
    }
});
</script>
{% endblock %}